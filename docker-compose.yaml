---
services:
  gitlab:
    container_name: gitlab
    image: gitlab/gitlab-ce:17.9.0-ce.0
    ports:
      - 80:80
      - 443:443
      - 22:22
    environment:
      - DNS_NAME=localhost
      - CERT_SANS=gitlab.vpn.test,www.gitlab.vpn.test
    volumes:
      - ./config/:/etc/gitlab
      - ./logs/:/var/log/gitlab
      - ./data/:/var/opt/gitlab
      - ./step/config/defaults.json:/defaults.json:z
      - ./step/secrets/password:/password:z
      - ./resources/cmd.sh:/cmd.sh
      - ./resources/step-cli_0.28.3-1_amd64.deb:/home/step-cli_amd64.deb
    healthcheck:
      test: ["CMD-SHELL", "curl -k https://gitlab/users/sign_in"]
      interval: 2m
      timeout: 5s
      retries: 5
      start_period: 2m
      start_interval: 30s
    command: ["/cmd.sh"]
    depends_on:
      - acme
    restart: unless-stopped

  acme:
    container_name: git-acme
    image: smallstep/step-ca:0.28.1
    env_file:
      - ./resources/step.env
    volumes:
      - ./step:/home/step
    healthcheck:
      test: ["CMD-SHELL", "curl -k https://acme:9000/health"]
      interval: 1m30s
      timeout: 3s
      retries: 5
      start_period: 1s
    restart: unless-stopped
